<% content_for :title, t('.page_title') %>

<div class="row modal-body">
  <div class="page-head">
      <h1 class="page-header" ng-show="chatView"><span class="fa fa-envelope"></span>
          <%= t('.page_header') %> 
        <a href="/#/create_message"><button class="btn btn-primary pull-right"><i class="fa fa-plus"></i> <span class="hidden-xs"><%= t('.page_title') %></span></button></a>
        <button class="btn btn-primary" ng-click="sendFlatChatMessge()">create flatchat</button>
      </h1>
      <h3 class="page-header" ng-show="chatView == false"><span class="fa fa-envelope"></span>
          <span ng-show="!flatchatActive">
          {{chatPartner.name}}
          </span>
          <span ng-show="flatchatActive">
          {{flatchat.flat_name}}
        <a href="/#/create_message"><button class="btn btn-primary pull-right"><i class="fa fa-plus"></i> <span class="hidden-xs"><%= t('.page_title') %></span></button></a></h3>
  </div>
</div>

<div class="container modal-body" ng-show="chatView">
<!-- start flatChat -->
  <div class="row">
  <div ng-init="countUnreadFlatChat()">
      <a style="cursor:pointer; text-decoration: none;" ng-click="getFlatChatMessages()" ng-click="toggleView()" onclick="start()">
        <div class="panel panel-success">
          <div class="list-group-item list-group-item-danger">
            <div class="btn-group pull-right">
              <button type="button" class="btn btn-default btn-xs" ng-click="removeFlatChat('<%= t('.questionDeleteChat') %>')">
                <span class="glyphicon glyphicon-trash"></span>
              </button>
              <button type="button" style="background-color:transparent" class="btn btn-default btn-xs">
                <span class="badge" style="background-color:CornflowerBlue">{{getFlatUnreadCounter()}}</span>
              </button>
            </div>
            <strong><i class="fa fa-home"></i> {{flatchat.flat_name}}</strong>
          </div>
          <div class="panel-footer">
            <div class="row">
              <div class="col-xs-6 col-md-6">
                <span><i class="fa fa-angle-double-right"></i> {{flatchat.sender_name}}:
                </span> {{flatchat.text}}
              </div>
              <div class="col-xs-6 col-md-6">
                <span class="time"><p class="text-right" style="font-size:x-small"><i class="fa fa-clock-o"></i>
                {{parseTime(flatchat.time, "0")}}</p></span>
              </div>
            </div>
          </div>
        </div>
      </a>
  </div>
  </div>
<!-- end flatChat -->
  <div class="row" ng-repeat="chat in chats track by $index">
    <div ng-init="countUnread(chat, $index)">
      <a style="cursor:pointer; text-decoration: none;" ng-click="getMessages(chat, index)" ng-click="toggleView()" onclick="start()">
        <div class="panel panel-success" ng-show="getUnreadCounter($index) < 1">
          <div class="list-group-item">
            <div class="btn-group pull-right">
              <button type="button" class="btn btn-default btn-xs" ng-click="removeChat(chat, '<%= t('.questionDeleteChat') %>')">
                <span class="glyphicon glyphicon-trash"></span>
              </button>
              <button type="button" style="background-color:transparent" class="btn btn-default btn-xs">
                <span class="badge" style="background-color:CornflowerBlue">{{getUnreadCounter($index)}}</span>
              </button>
            </div>
            <strong>{{chat.partner}}</strong>
          </div>
          <div class="panel-footer">
            <div class="row">
              <div class="col-xs-6 col-md-6">
                <span ng-show="!checkLastSender(chat.partner_id, chat.sender_id)">
                  <i class="fa fa-check-circle"></i>
                </span>
                <span ng-show="checkLastSender(chat.partner_id, chat.sender_id)"><i class="fa fa-angle-double-right"></i> {{chat.sender_name}}:
                </span> {{chat.text}}
              </div>
              <div class="col-xs-6 col-md-6">
                <span class="time"><p class="text-right" style="font-size:x-small"><i class="fa fa-clock-o"></i> {{parseTime(chat.time, "0")}}</p></span>
              </div>
            </div>
          </div>
        </div>
      </a>
      <a style="cursor:pointer; text-decoration: none;" ng-click="getMessages(chat, index)" ng-click="toggleView()" onclick="start()">
        <div class="panel panel-success" ng-show="getUnreadCounter($index) > 0">
          <div class="list-group-item list-group-item-success">
            <div class="btn-group pull-right">
              <button type="button" class="btn btn-default btn-xs" ng-click="removeChat(chat, '<%= t('.questionDeleteChat') %>')">
                <span class="glyphicon glyphicon-trash"></span>
              </button>
              <button type="button" style="background-color:transparent" class="btn btn-default btn-xs">
                <span class="badge" style="background-color:CornflowerBlue">{{getUnreadCounter($index)}}</span>
              </button>
            </div>
            <strong>{{chat.partner}}</strong>
          </div>
          <div class="panel-footer">
            <div class="row">
              <div class="col-xs-6 col-md-6">
                <span ng-show="!checkLastSender(chat.partner_id, chat.sender_id)">
                  <i class="fa fa-check-circle"></i>
                </span>
                <span ng-show="checkLastSender(chat.partner_id, chat.sender_id)"><i class="fa fa-angle-double-right"></i> {{chat.sender_name}}:
                </span> {{chat.text}}
              </div>
              <div class="col-xs-6 col-md-6">
                <span class="time"><p class="text-right" style="font-size:x-small"><i class="fa fa-clock-o"></i> {{parseTime(chat.time, "0")}}</p></span>
              </div>
            </div>
          </div>
        </div>
      </a>
    </div>
  </div>
</div>
<body>
<div ng-show="chatView == false">
  <div class="modal-body" name="scrollarea" id="scrollarea" style="height: 270px; overflow-y: auto; overflow-x: hidden;">
    <div ng-repeat="message in messages" ng-show="!flatchatActive">
        <div class="panel panel-success" ng-show="!currentlyRead(message) || currentUserIsSender(message)">
            <div class="list-group-item" ng-model="Username"><strong>{{message.sender_name}}</strong>
              <span class="time pull-right" style="font-size:x-small"><i class="fa fa-clock-o"></i> {{parseTime(message.created_at, "1")}}</span>
            </div>
            <div class="panel-footer">
                <div class="row">
                  <div class="col-xs-12 col-md-12">{{message.text}}</div>
                </div>
            </div>
        </div>
        <div class="panel panel-success" ng-show="!currentUserIsSender(message) && currentlyRead(message)">
            <div class="list-group-item list-group-item-success" ng-model="Username"><strong>{{message.sender_name}}</strong>
              <span class="time pull-right" style="font-size:x-small"><i class="fa fa-clock-o"></i> {{parseTime(message.created_at, "1")}}</span>
            </div>
            <div class="panel-footer">
                <div class="row">
                  <div class="col-xs-12 col-md-12">{{message.text}}</div>
                </div>
            </div>
        </div>
    </div>
    <div ng-show="flatchatActive" ng-repeat="message in flatchatMessages">
        <div class="panel panel-success" ng-show="!currentlyRead(message) || currentUserIsSender(message)">
            <div class="list-group-item" ng-model="Username"><strong>{{message.sender_name}}</strong>
              <span class="time pull-right" style="font-size:x-small"><i class="fa fa-clock-o"></i> {{parseTime(message.created_at, "1")}}</span>
            </div>
            <div class="panel-footer">
                <div class="row">
                  <div class="col-xs-12 col-md-12">{{message.text}}</div>
                </div>
            </div>
        </div>
        <div class="panel panel-success" ng-show="!currentUserIsSender(message) && currentlyRead(message)">
            <div class="list-group-item list-group-item-success" ng-model="Username"><strong>{{message.sender_name}}</strong>
              <span class="time pull-right" style="font-size:x-small"><i class="fa fa-clock-o"></i> {{parseTime(message.created_at, "1")}}</span>
            </div>
            <div class="panel-footer">
                <div class="row">
                  <div class="col-xs-12 col-md-12">{{message.text}}</div>
                </div>
            </div>
        </div>
    </div>
  </div>
  <div class="modal-footer">
    <form role="form" name="SendForm" ng-submit="sendMessage()">
        <div class="row">
          <div class="col-lg-10 col-md-10 col-sm-10">
              <textarea autofocus name="inputtext" id="inputtext" class="form-control" rows="3" ng-model="newMess.text" type="text" placeholder="<%= t('.new_text_placeholder') %>" required maxlength="255"></textarea>
          </div>
          <div class="col-lg-2 col-md-2 col-sm-2">
              <a style="text-decoration: none;">
                <span class="hidden-lg hidden-md hidden-sm">
                  <button style="margin-top: 6px" id="send" name="send" class="btn btn-primary btn-block" onclick="start()" type="submit" ng-click="sendMessage()" ng-disabled="!SendForm.$valid"><%= t('.send') %>
                  </button>
                </span>
                <span class="hidden-xs">
                  <button id="send2" name="send" class="btn btn-primary btn-block" onclick="start()" type="submit" ng-click="sendMessage()" ng-disabled="!SendForm.$valid"><%= t('.send') %>
                  </button>
                </span>
              </a>
              <a ng-click="toggleView()" style="text-decoration: none;"><button style="margin-top: 6px" type="button" class="btn btn-default btn-block"><%= t('buttons.labels.decision.close') %></button></a>
          </div>
        </div>
    </form>
  </div>
</div>
</body>
<div class="jumbotron text-center" ng-show="chats.length === 0 && !isLoading()">
    <i class="fa fa-envelope fa-5x"></i>
    <h3><%= t('.intro_header') %></h3>
    <%= t('.intro_text1') %> <br>
    <%= t('.intro_text2') %>
</div>
<script type="text/javascript">
  $(function() {
    $('textarea#inputtext').on('keyup', function(e) {
        if (e.which == 13 && ! e.shiftKey) {
            sendMessage();
        }
    });
    function sendMessage(){
      $('button#send').click();
      start();
    };
});
</script>

<!-- todo
- optimieren
- text der angezeigt wird begrenzen
- messages nav bar back
- model body height
- delete for both users?
-->

